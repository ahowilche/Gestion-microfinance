{%extends "../home.html"%}{%block content%}
<style>
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }

  body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
      sans-serif;
    background-color: #f9fafb;
    color: #111827;
    line-height: 1.6;
  }

  .container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 24px;
  }

  .welcome-section {
    margin-bottom: 2rem;
  }

  .welcome-section h2 {
    font-size: 1.5rem;
    font-weight: bold;
    color: #111827;
    margin-bottom: 0.5rem;
  }

  .btn {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 10px 20px;
    border-radius: 6px;
    font-size: 14px;
    font-weight: 500;
    text-decoration: none;
    border: none;
    cursor: pointer;
    transition: all 0.2s;
  }

  .btn-primary {
    background-color: #2563eb;
    color: white;
  }

  .btn-primary:hover {
    background-color: #1d4ed8;
  }

  .btn-outline {
    border: 1px solid #d1d5db;
    background: white;
    color: #374151;
  }

  .btn-outline:hover {
    background-color: #f9fafb;
  }

  .btn-sm {
    padding: 6px 12px;
    font-size: 12px;
  }

  .card {
    background: white;
    border-radius: 8px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    border: 1px solid #e5e7eb;
    margin-bottom: 24px;
  }

  .card-header {
    padding: 24px 24px 16px;
    border-bottom: 1px solid #e5e7eb;
  }

  .card-title {
    font-size: 18px;
    font-weight: 600;
    margin-bottom: 16px;
  }

  .card-content {
    padding: 24px;
  }

  .credits-table {
    width: 100%;
    border-collapse: collapse;
  }

  .credits-table th,
  .credits-table td {
    padding: 12px;
    text-align: left;
    border-bottom: 1px solid #e5e7eb;
  }

  .credits-table th {
    font-weight: 600;
    color: #374151;
    background-color: #f9fafb;
  }

  .status-badge {
    display: inline-block;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 12px;
    font-weight: 500;
  }

  .status-en-cours {
    background-color: #dbeafe;
    color: #1e40af;
  }

  .status-rembourse {
    background-color: #dcfce7;
    color: #166534;
  }

  .status-annule {
    background-color: #fee2e2;
    color: #dc2626;
  }

  .status-retard {
    background-color: #fef3c7;
    color: #d97706;
  }

  .amount {
    font-weight: 600;
    color: #059669;
  }

  .progress-bar {
    width: 100%;
    height: 8px;
    background-color: #e5e7eb;
    border-radius: 4px;
    overflow: hidden;
  }

  .progress-fill {
    height: 100%;
    background-color: #059669;
    transition: width 0.3s ease;
  }

  .modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
  }

  .modal-content {
    background-color: white;
    margin: 5% auto;
    padding: 0;
    border-radius: 8px;
    width: 90%;
    max-width: 600px;
    max-height: 90vh;
    overflow-y: auto;
  }

  .modal-header {
    padding: 20px 24px;
    border-bottom: 1px solid #e5e7eb;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .modal-title {
    font-size: 18px;
    font-weight: 600;
  }

  .close {
    background: none;
    border: none;
    font-size: 24px;
    cursor: pointer;
    color: #6b7280;
  }

  .modal-body {
    padding: 24px;
  }

  .form-group {
    margin-bottom: 20px;
  }

  label {
    display: block;
    font-weight: 500;
    margin-bottom: 8px;
    color: #374151;
  }

  .required {
    color: #ef4444;
  }

  input,
  select,
  textarea {
    width: 100%;
    padding: 10px 12px;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    font-size: 14px;
    transition: border-color 0.2s;
  }

  input:focus,
  select:focus,
  textarea:focus {
    outline: none;
    border-color: #2563eb;
    box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
  }

  .form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
  }

  @media (max-width: 768px) {
    .container {
      padding: 16px;
    }

    .header {
      flex-direction: column;
      align-items: flex-start;
    }

    .credits-table {
      font-size: 14px;
    }

    .form-row {
      grid-template-columns: 1fr;
    }

    .modal-content {
      margin: 10% auto;
      width: 95%;
    }
  }
</style>

<div class="container">
  <div class="page-inner">
    <!-- Welcome Section -->
    <section class="welcome-section">
      <h2>Gestion des Crédits</h2>
      <button class="btn btn-primary" onclick="openModal('addCreditModal')">
        <svg
          width="16"
          height="16"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M12 4v16m8-8H4"
          ></path>
        </svg>
        Nouveau Crédit
      </button>
    </section>

    <div class="card">
      <div class="card-header">
        <h2 class="card-title">Liste des Crédits</h2>
      </div>
      <div class="card-content">
        <div style="overflow-x: auto">
          <table class="credits-table">
            <thead>
              <tr>
                <th>N° Crédit</th>
                <th>Client</th>
                <th>Montant</th>
                <th>Taux</th>
                <th>Durée</th>
                <th>Progression</th>
                <th>Statut</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="creditsTableBody">
              <!-- Les crédits seront ajoutés ici par JavaScript -->
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Ajouter Crédit -->
  <div id="addCreditModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">Nouveau Crédit</h3>
        <button class="close" onclick="closeModal('addCreditModal')">
          &times;
        </button>
      </div>
      <div class="modal-body">
        <form id="addCreditForm">
          <div class="form-group">
            <label for="clientSelect"
              >Client <span class="required">*</span></label
            >
            <select id="clientSelect" name="client" required>
              <option value="">Sélectionner un client</option>
              <option value="CLI001">Jean Dupont</option>
              <option value="CLI002">Marie Martin</option>
              <option value="CLI003">Pierre Durand</option>
              <option value="CLI004">Sophie Leblanc</option>
            </select>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="creditAmount"
                >Montant (€) <span class="required">*</span></label
              >
              <input
                type="number"
                id="creditAmount"
                name="amount"
                step="100"
                min="1000"
                placeholder="10000"
                required
              />
            </div>
            <div class="form-group">
              <label for="creditRate"
                >Taux annuel (%) <span class="required">*</span></label
              >
              <input
                type="number"
                id="creditRate"
                name="rate"
                step="0.1"
                min="0.1"
                max="20"
                placeholder="3.5"
                required
              />
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="creditDuration"
                >Durée (mois) <span class="required">*</span></label
              >
              <input
                type="number"
                id="creditDuration"
                name="duration"
                min="6"
                max="360"
                placeholder="60"
                required
              />
            </div>
            <div class="form-group">
              <label for="creditType"
                >Type de crédit <span class="required">*</span></label
              >
              <select id="creditType" name="type" required>
                <option value="personnel">Crédit Personnel</option>
                <option value="immobilier">Crédit Immobilier</option>
                <option value="auto">Crédit Auto</option>
                <option value="consommation">Crédit Consommation</option>
              </select>
            </div>
          </div>

          <div class="form-group">
            <label for="creditPurpose">Objet du crédit</label>
            <textarea
              id="creditPurpose"
              name="purpose"
              rows="3"
              placeholder="Description de l'utilisation prévue du crédit..."
            ></textarea>
          </div>

          <div
            style="
              display: flex;
              justify-content: flex-end;
              gap: 16px;
              margin-top: 24px;
            "
          >
            <button
              type="button"
              class="btn btn-outline"
              onclick="closeModal('addCreditModal')"
            >
              Annuler
            </button>
            <button type="submit" class="btn btn-primary">
              Créer le Crédit
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
  // Données de test
  const credits = [
    {
      id: "CRD001",
      client: "Jean Dupont",
      clientId: "CLI001",
      amount: 50000,
      rate: 3.5,
      duration: 60,
      type: "immobilier",
      status: "en-cours",
      startDate: "2024-01-15",
      monthlyPayment: 905.15,
      paidMonths: 8,
      remainingAmount: 42000,
    },
    {
      id: "CRD002",
      client: "Marie Martin",
      clientId: "CLI002",
      amount: 15000,
      rate: 4.2,
      duration: 36,
      type: "auto",
      status: "en-cours",
      startDate: "2024-02-01",
      monthlyPayment: 445.5,
      paidMonths: 6,
      remainingAmount: 13200,
    },
    {
      id: "CRD003",
      client: "Pierre Durand",
      clientId: "CLI003",
      amount: 8000,
      rate: 5.8,
      duration: 24,
      type: "personnel",
      status: "rembourse",
      startDate: "2022-06-01",
      monthlyPayment: 354.2,
      paidMonths: 24,
      remainingAmount: 0,
    },
  ];

  function formatCurrency(amount) {
    return new Intl.NumberFormat("fr-FR", {
      style: "currency",
      currency: "EUR",
    }).format(amount);
  }

  function getStatusBadge(status) {
    const statusLabels = {
      "en-cours": "En cours",
      rembourse: "Remboursé",
      annule: "Annulé",
      retard: "En retard",
    };
    return `<span class="status-badge status-${status}">${statusLabels[status]}</span>`;
  }

  function calculateProgress(paidMonths, totalDuration) {
    return Math.round((paidMonths / totalDuration) * 100);
  }

  function renderCreditsTable() {
    const tbody = document.getElementById("creditsTableBody");
    tbody.innerHTML = credits
      .map((credit) => {
        const progress = calculateProgress(credit.paidMonths, credit.duration);
        return `
                    <tr>
                        <td><strong>${credit.id}</strong></td>
                        <td>${credit.client}</td>
                        <td class="amount">${formatCurrency(credit.amount)}</td>
                        <td>${credit.rate}%</td>
                        <td>${credit.duration} mois</td>
                        <td>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <div class="progress-bar" style="flex: 1;">
                                    <div class="progress-fill" style="width: ${progress}%"></div>
                                </div>
                                <span style="font-size: 12px; color: #6b7280;">${progress}%</span>
                            </div>
                        </td>
                        <td>${getStatusBadge(credit.status)}</td>
                        <td>
                            <div style="display: flex; gap: 8px;">
                                <button class="btn btn-outline btn-sm" onclick="viewCredit('${
                                  credit.id
                                }')">Détails</button>
                                ${
                                  credit.status === "en-cours"
                                    ? `<button class="btn btn-outline btn-sm" onclick="addPayment('${credit.id}')">Remboursement</button>`
                                    : ""
                                }
                            </div>
                        </td>
                    </tr>
                `;
      })
      .join("");
  }

  function openModal(modalId) {
    document.getElementById(modalId).style.display = "block";
  }

  function closeModal(modalId) {
    document.getElementById(modalId).style.display = "none";
  }

  function viewCredit(creditId) {
    const credit = credits.find((c) => c.id === creditId);
    if (credit) {
      alert(
        `Détails du crédit ${credit.id}:\n\nClient: ${
          credit.client
        }\nMontant: ${formatCurrency(credit.amount)}\nTaux: ${
          credit.rate
        }%\nDurée: ${credit.duration} mois\nMensualité: ${formatCurrency(
          credit.monthlyPayment
        )}\nMois payés: ${credit.paidMonths}/${
          credit.duration
        }\nRestant à payer: ${formatCurrency(credit.remainingAmount)}`
      );
    }
  }

  function addPayment(creditId) {
    const credit = credits.find((c) => c.id === creditId);
    if (credit && credit.paidMonths < credit.duration) {
      const amount = prompt(
        `Montant du remboursement pour ${
          credit.client
        } (Mensualité normale: ${formatCurrency(credit.monthlyPayment)}):`
      );
      if (amount && !isNaN(amount) && parseFloat(amount) > 0) {
        credit.paidMonths++;
        credit.remainingAmount = Math.max(
          0,
          credit.remainingAmount - parseFloat(amount)
        );

        if (
          credit.paidMonths >= credit.duration ||
          credit.remainingAmount <= 0
        ) {
          credit.status = "rembourse";
          credit.remainingAmount = 0;
        }

        renderCreditsTable();
        alert(
          `Remboursement de ${formatCurrency(
            parseFloat(amount)
          )} enregistré pour ${credit.client}`
        );
      }
    }
  }

  // Génération d'un numéro de crédit
  function generateCreditNumber() {
    const timestamp = Date.now().toString().slice(-6);
    const random = Math.floor(Math.random() * 100)
      .toString()
      .padStart(2, "0");
    return `CRD${timestamp}${random}`;
  }

  // Formulaire d'ajout de crédit
  document
    .getElementById("addCreditForm")
    .addEventListener("submit", function (e) {
      e.preventDefault();

      const formData = new FormData(this);
      const amount = parseFloat(formData.get("amount"));
      const rate = parseFloat(formData.get("rate"));
      const duration = parseInt(formData.get("duration"));

      // Calcul de la mensualité (formule approximative)
      const monthlyRate = rate / 100 / 12;
      const monthlyPayment =
        (amount * (monthlyRate * Math.pow(1 + monthlyRate, duration))) /
        (Math.pow(1 + monthlyRate, duration) - 1);

      const newCredit = {
        id: generateCreditNumber(),
        client:
          formData.get("client") === "CLI001"
            ? "Jean Dupont"
            : formData.get("client") === "CLI002"
            ? "Marie Martin"
            : formData.get("client") === "CLI003"
            ? "Pierre Durand"
            : "Sophie Leblanc",
        clientId: formData.get("client"),
        amount: amount,
        rate: rate,
        duration: duration,
        type: formData.get("type"),
        status: "en-cours",
        startDate: new Date().toISOString().split("T")[0],
        monthlyPayment: monthlyPayment,
        paidMonths: 0,
        remainingAmount: amount,
      };

      credits.push(newCredit);
      renderCreditsTable();
      closeModal("addCreditModal");
      this.reset();

      alert(
        `Crédit ${newCredit.id} créé avec succès!\nMensualité: ${formatCurrency(
          monthlyPayment
        )}`
      );
    });

  // Fermer les modals en cliquant à l'extérieur
  window.onclick = function (event) {
    const modals = document.querySelectorAll(".modal");
    modals.forEach((modal) => {
      if (event.target === modal) {
        modal.style.display = "none";
      }
    });
  };

  // Rendu initial
  renderCreditsTable();
</script>
{%endblock%}
