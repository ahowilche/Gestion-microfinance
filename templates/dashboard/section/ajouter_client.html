{%extends "../home.html"%} {%block content%}
<div class="container">
  <div class="page-inner">
    <!-- Navigation -->

    <section class="welcome-section">
      <h2>Ajouter un nouveau client</h2>
      <p>Saisissez les informations du nouveau client</p>
    </section>

    <!-- Form -->
    <div class="card">
      <form id="clientForm" class="client-form">
        <div class="form-row">
          <div class="form-group">
            <label for="nom">Nom *</label>
            <input
              type="text"
              id="nom"
              name="nom"
              placeholder="Entrez le nom"
              required
            />
          </div>
          <div class="form-group">
            <label for="prenom">Pr√©nom *</label>
            <input
              type="text"
              id="prenom"
              name="prenom"
              placeholder="Entrez le pr√©nom"
              required
            />
          </div>
        </div>

        <div class="form-group">
          <label for="telephone">T√©l√©phone *</label>
          <input
            type="tel"
            id="telephone"
            name="telephone"
            placeholder="Ex: 0123456789"
            required
          />
        </div>

        <div class="form-group">
          <label for="adresse">Adresse *</label>
          <input
            type="text"
            id="adresse"
            name="adresse"
            placeholder="Entrez l'adresse compl√®te"
            required
          />
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="numeroIdentifiant">Num√©ro d'identifiant *</label>
            <input
              type="text"
              id="numeroIdentifiant"
              name="numeroIdentifiant"
              placeholder="Ex: ID001"
              required
            />
          </div>
          <div class="form-group">
            <label for="dateInscription">Date d'inscription *</label>
            <input
              type="date"
              id="dateInscription"
              name="dateInscription"
              required
            />
          </div>
        </div>

        <div class="form-actions">
          <a href="liste-clients.html" class="btn btn-outline"> Annuler </a>
          <button type="submit" class="btn btn-primary">
            <span class="icon">üíæ</span>
            <span id="submitButtonText">Ajouter le client</span>
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Toast Notification -->
<div id="toast" class="toast">
  <span id="toastMessage"></span>
</div>

<script>
  // Charger les clients depuis localStorage
  function loadClients() {
    const savedClients = localStorage.getItem("clients");
    return savedClients ? JSON.parse(savedClients) : [];
  }

  // Sauvegarder les clients dans localStorage
  function saveClients(clients) {
    localStorage.setItem("clients", JSON.stringify(clients));
  }

  // Afficher le toast
  function showToast(message, isError = false) {
    const toast = document.getElementById("toast");
    const toastMessage = document.getElementById("toastMessage");

    toastMessage.textContent = message;
    toast.className = isError ? "toast error show" : "toast show";

    setTimeout(() => {
      toast.classList.remove("show");
    }, 3000);
  }

  // Obtenir les param√®tres URL
  function getUrlParams() {
    const params = new URLSearchParams(window.location.search);
    return {
      id: params.get("id"),
      mode: params.get("mode") || "add",
    };
  }

  // Charger un client pour modification
  function loadClientForEdit(clientId) {
    const clients = loadClients();
    const client = clients.find((c) => c.id === clientId);

    if (!client) {
      showToast("Client non trouv√©.", true);
      setTimeout(() => {
        window.location.href = "liste-clients.html";
      }, 2000);
      return;
    }

    // Mettre √† jour les titres
    document.getElementById("formTitle").textContent = "Modifier le client";
    document.getElementById("formDescription").textContent =
      "Modifiez les informations du client";
    document.getElementById("submitButtonText").textContent = "Sauvegarder";

    // Remplir le formulaire
    document.getElementById("nom").value = client.nom;
    document.getElementById("prenom").value = client.prenom;
    document.getElementById("telephone").value = client.telephone;
    document.getElementById("adresse").value = client.adresse;
    document.getElementById("numeroIdentifiant").value =
      client.numeroIdentifiant;
    document.getElementById("dateInscription").value = client.dateInscription;
  }

  // G√©rer la soumission du formulaire
  function handleFormSubmit(event) {
    event.preventDefault();

    const { id, mode } = getUrlParams();
    const formData = new FormData(event.target);
    const clients = loadClients();

    const clientData = {
      nom: formData.get("nom"),
      prenom: formData.get("prenom"),
      telephone: formData.get("telephone"),
      adresse: formData.get("adresse"),
      numeroIdentifiant: formData.get("numeroIdentifiant"),
      dateInscription: formData.get("dateInscription"),
    };

    if (mode === "edit" && id) {
      // Modification
      const clientIndex = clients.findIndex((c) => c.id === id);
      if (clientIndex === -1) {
        showToast("Client non trouv√©.", true);
        return;
      }

      clients[clientIndex] = {
        ...clients[clientIndex],
        ...clientData,
      };

      showToast(
        `${clientData.prenom} ${clientData.nom} a √©t√© modifi√© avec succ√®s.`
      );
    } else {
      // Ajout
      const newClient = {
        ...clientData,
        id: Date.now().toString(),
        comptes: [],
      };

      clients.push(newClient);
      showToast(
        `${clientData.prenom} ${clientData.nom} a √©t√© ajout√© avec succ√®s.`
      );
    }

    saveClients(clients);

    // Redirection apr√®s 1.5 secondes
    setTimeout(() => {
      window.location.href = "liste-clients.html";
    }, 1500);
  }

  // Initialisation
  document.addEventListener("DOMContentLoaded", function () {
    const { id, mode } = getUrlParams();

    // D√©finir la date d'inscription par d√©faut √† aujourd'hui
    const today = new Date().toISOString().split("T")[0];
    document.getElementById("dateInscription").value = today;

    // Si mode √©dition, charger les donn√©es du client
    if (mode === "edit" && id) {
      loadClientForEdit(id);
    }

    // Event listener pour le formulaire
    document
      .getElementById("clientForm")
      .addEventListener("submit", handleFormSubmit);
  });

  // Fonctions utilitaires pour cr√©er des liens de modification
  function createEditUrl(clientId) {
    return `formulaire-client.html?mode=edit&id=${clientId}`;
  }

  // Exposer la fonction globalement pour pouvoir l'utiliser depuis liste-clients.js
  window.createEditUrl = createEditUrl;
</script>
{%endblock%}
