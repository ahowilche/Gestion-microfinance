{%extends '../home.html'%} {%block content%}
<style>
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }

  body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
      sans-serif;
    background-color: #f9fafb;
    color: #111827;
    line-height: 1.6;
  }

  .container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 24px;
  }

  .header {
    margin-bottom: 24px;
  }

  .back-btn {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 8px 16px;
    background: white;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    text-decoration: none;
    color: #374151;
    font-size: 14px;
    margin-bottom: 16px;
    transition: background-color 0.2s;
  }

  .back-btn:hover {
    background-color: #f9fafb;
  }

  .page-title {
    font-size: 2rem;
    font-weight: bold;
    color: #111827;
    margin-bottom: 8px;
  }

  .page-subtitle {
    color: #6b7280;
  }

  .card {
    background: white;
    border-radius: 8px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    border: 1px solid #e5e7eb;
    margin-bottom: 24px;
    overflow: hidden;
  }

  .card-header {
    padding: 24px 24px 16px;
    border-bottom: 1px solid #e5e7eb;
  }

  .card-title {
    font-size: 1.25rem;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .card-content {
    display: block;
    padding: 24px;
  }

  .grid {
    display: grid;
    grid-template-columns: 1fr 2fr;
    gap: 24px;
  }

  @media (max-width: 1024px) {
    .grid {
      grid-template-columns: 1fr;
    }
  }

  .form-group {
    margin-bottom: 16px;
  }

  .form-label {
    display: block;
    font-size: 0.875rem;
    font-weight: 500;
    color: #374151;
    margin-bottom: 4px;
  }

  .form-select,
  .form-input,
  .form-textarea {
    width: 100%;
    padding: 8px 12px;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    font-size: 0.875rem;
    transition: border-color 0.2s;
  }

  .form-select:focus,
  .form-input:focus,
  .form-textarea:focus {
    outline: none;
    border-color: #2563eb;
    box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
  }

  .form-textarea {
    min-height: 80px;
    font-family: inherit;
    resize: vertical;
  }

  .form-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
    margin-bottom: 16px;
  }

  @media (max-width: 768px) {
    .form-grid {
      grid-template-columns: 1fr;
    }
  }

  .form-hint {
    font-size: 0.75rem;
    color: #6b7280;
    margin-top: 4px;
  }

  .btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    padding: 10px 20px;
    border-radius: 6px;
    font-size: 14px;
    font-weight: 500;
    text-decoration: none;
    border: none;
    cursor: pointer;
    transition: all 0.2s;
  }

  .btn-primary {
    background-color: #2563eb;
    color: white;
    width: 100%;
  }

  .btn-primary:hover {
    background-color: #1d4ed8;
  }

  .btn-primary:disabled {
    background-color: #9ca3af;
    cursor: not-allowed;
  }

  .info-section {
    margin-bottom: 24px;
  }

  .info-label {
    font-size: 0.875rem;
    font-weight: 500;
    color: #6b7280;
    margin-bottom: 4px;
  }

  .info-value {
    font-weight: 500;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .info-sub {
    font-size: 0.875rem;
    color: #6b7280;
  }

  .amount-primary {
    font-size: 1.125rem;
    font-weight: bold;
    color: #059669;
  }

  .amount-warning {
    font-size: 1.125rem;
    font-weight: bold;
    color: #d97706;
  }

  .progress-section {
    margin-top: 16px;
  }

  .progress-header {
    display: flex;
    justify-content: space-between;
    font-size: 0.875rem;
    margin-bottom: 4px;
  }

  .progress-bar {
    width: 100%;
    height: 8px;
    background-color: #e5e7eb;
    border-radius: 4px;
    overflow: hidden;
  }

  .progress-fill {
    height: 100%;
    background-color: #059669;
    transition: width 0.3s ease;
  }

  .progress-labels {
    display: flex;
    justify-content: space-between;
    font-size: 0.75rem;
    color: #6b7280;
    margin-top: 4px;
  }

  .table {
    width: 100%;
    border-collapse: collapse;
  }

  .table th,
  .table td {
    padding: 12px 8px;
    text-align: left;
    border-bottom: 1px solid #e5e7eb;
  }

  .table th {
    font-weight: 500;
    color: #6b7280;
    font-size: 0.875rem;
  }

  .table tr:hover {
    background-color: #f9fafb;
  }

  .payment-method-badge {
    display: inline-block;
    padding: 2px 8px;
    background-color: #dbeafe;
    color: #1e40af;
    font-size: 0.75rem;
    border-radius: 4px;
  }

  .loading {
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 400px;
    flex-direction: column;
    gap: 16px;
  }

  .spinner {
    width: 48px;
    height: 48px;
    border: 3px solid #e5e7eb;
    border-top: 3px solid #2563eb;
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }

  @keyframes spin {
    0% {
      transform: rotate(0deg);
    }
    100% {
      transform: rotate(360deg);
    }
  }

  .empty-state {
    text-align: center;
    padding: 48px 16px;
    color: #6b7280;
  }

  .empty-icon {
    width: 48px;
    height: 48px;
    margin: 0 auto 12px;
    color: #d1d5db;
  }

  .credit-selector {
    background: white;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    padding: 8px 12px;
    font-size: 0.875rem;
    cursor: pointer;
  }

  .credit-option {
    padding: 8px 0;
    border-bottom: 1px solid #f3f4f6;
  }

  .credit-option:last-child {
    border-bottom: none;
  }

  .credit-main {
    font-weight: 500;
    margin-bottom: 4px;
  }

  .credit-detail {
    font-size: 0.75rem;
    color: #6b7280;
  }

  .icon {
    width: 16px;
    height: 16px;
    fill: none;
    stroke: currentColor;
    stroke-width: 2;
    stroke-linecap: round;
    stroke-linejoin: round;
  }

  .max-width-md {
    max-width: 400px;
  }

  .hidden {
    display: none;
  }
</style>

<div class="container">
  <div class="page-inner">
    <section class="welcome-section">
      <h2>Remboursement de Crédit</h2>
      <p>Sélectionnez un crédit et enregistrez un nouveau remboursement</p>
    </section>

    <!-- Loading State -->
    <div id="loadingState" class="loading">
      <div class="spinner"></div>
      <p>Chargement des crédits disponibles...</p>
    </div>

    <!-- Credit Selection -->
    <div id="creditSelection" class="card hidden">
      <div class="card-header">
        <h2 class="card-title">
          <svg class="icon" viewBox="0 0 24 24">
            <circle cx="11" cy="11" r="8" />
            <path d="m21 21-4.35-4.35" />
          </svg>
          Sélection du Crédit
        </h2>
      </div>
      <div class="card-content">
        <div class="max-width-md">
          <label class="form-label" for="credit-select"
            >Choisir un crédit *</label
          >
          <select id="credit-select" class="form-select">
            <option value="">Sélectionnez un crédit à rembourser</option>
          </select>
        </div>
      </div>
    </div>

    <!-- Main Content -->
    <div id="mainContent" class="grid hidden">
      <!-- Credit Information -->
      <div>
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">
              <svg class="icon" viewBox="0 0 24 24">
                <rect width="20" height="14" x="2" y="5" rx="2" />
                <line x1="2" x2="22" y1="10" y2="10" />
              </svg>
              Informations du Crédit
            </h2>
          </div>
          <div class="card-content">
            <div class="info-section">
              <div class="info-label">Numéro de crédit</div>
              <p style="font-weight: 600; color: #2563eb" id="creditNumber">
                -
              </p>
            </div>

            <div class="info-section">
              <div class="info-label">Client</div>
              <div class="info-value">
                <svg class="icon" viewBox="0 0 24 24">
                  <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" />
                  <circle cx="12" cy="7" r="4" />
                </svg>
                <span id="clientName">-</span>
              </div>
              <p class="info-sub" id="accountNumber">-</p>
            </div>

            <div class="info-section">
              <div class="info-label">Montant du crédit</div>
              <div class="info-value">
                <svg class="icon" viewBox="0 0 24 24">
                  <line x1="12" x2="12" y1="2" y2="22" />
                  <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6" />
                </svg>
                <span class="amount-primary" id="creditAmount">-</span>
              </div>
            </div>

            <div class="info-section">
              <div class="info-label">Taux d'intérêt</div>
              <p id="interestRate">-</p>
            </div>

            <div class="info-section">
              <div class="info-label">Durée</div>
              <p id="duration">-</p>
            </div>

            <div class="info-section">
              <div class="info-label">Progression</div>
              <div class="progress-section">
                <div class="progress-header">
                  <span>Remboursé</span>
                  <span id="progressPercent">0%</span>
                </div>
                <div class="progress-bar">
                  <div
                    class="progress-fill"
                    id="progressFill"
                    style="width: 0%"
                  ></div>
                </div>
                <div class="progress-labels">
                  <span id="paidAmount">0 FCFA</span>
                  <span id="totalAmount">0 FCFA</span>
                </div>
              </div>
            </div>

            <div
              class="info-section"
              style="padding-top: 16px; border-top: 1px solid #e5e7eb"
            >
              <div class="info-label">Montant restant</div>
              <p class="amount-warning" id="remainingAmount">-</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Payment Form and History -->
      <div style="display: flex; flex-direction: column; gap: 24px">
        <!-- New Payment Form -->
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">Nouveau Remboursement</h2>
          </div>
          <div class="card-content">
            <form id="paymentForm">
              <div class="form-grid">
                <div class="form-group">
                  <label class="form-label" for="montant">Montant *</label>
                  <input
                    type="number"
                    id="montant"
                    name="montant"
                    class="form-input"
                    min="0"
                    step="0.01"
                    placeholder="Saisir le montant"
                    required
                  />
                  <p class="form-hint" id="maxAmountHint">Maximum: 0 FCFA</p>
                </div>

                <div class="form-group">
                  <label class="form-label" for="date_paiement"
                    >Date de paiement *</label
                  >
                  <input
                    type="date"
                    id="date_paiement"
                    name="date_paiement"
                    class="form-input"
                    required
                  />
                </div>

                <div class="form-group">
                  <label class="form-label" for="methode_paiement"
                    >Méthode de paiement *</label
                  >
                  <select
                    id="methode_paiement"
                    name="methode_paiement"
                    class="form-select"
                    required
                  >
                    <option value="ESPECES">Espèces</option>
                    <option value="MOBILE_MONEY">Mobile Money</option>
                  </select>
                </div>

                <div class="form-group">
                  <label class="form-label" for="reference">Référence</label>
                  <input
                    type="text"
                    id="reference"
                    name="reference"
                    class="form-input"
                    placeholder="Numéro de référence"
                  />
                </div>
              </div>

              <div class="form-group">
                <label class="form-label" for="notes">Notes (optionnel)</label>
                <textarea
                  id="notes"
                  name="notes"
                  class="form-textarea"
                  placeholder="Commentaires ou notes supplémentaires"
                  rows="3"
                ></textarea>
              </div>

              <button type="submit" class="btn btn-primary" id="submitBtn">
                Enregistrer le remboursement
              </button>
            </form>
          </div>
        </div>

        <!-- Payment History -->
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">
              <svg class="icon" viewBox="0 0 24 24">
                <path
                  d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"
                />
                <polyline points="14,2 14,8 20,8" />
                <line x1="16" x2="8" y1="13" y2="13" />
                <line x1="16" x2="8" y1="17" y2="17" />
                <polyline points="10,9 9,9 8,9" />
              </svg>
              Historique des remboursements
            </h2>
          </div>
          <div class="card-content">
            <div id="paymentsLoading" class="loading" style="min-height: 200px">
              <div class="spinner"></div>
              <p>Chargement de l'historique...</p>
            </div>

            <div id="paymentsTable" style="display: none">
              <div style="overflow-x: auto">
                <table class="table">
                  <thead>
                    <tr>
                      <th>Date</th>
                      <th>Montant</th>
                      <th>Méthode</th>
                      <th>Référence</th>
                      <th>Notes</th>
                    </tr>
                  </thead>
                  <tbody id="paymentsTableBody"></tbody>
                </table>
              </div>
            </div>

            <div id="paymentsEmpty" class="empty-state" style="display: none">
              <svg
                class="empty-icon"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
              >
                <path
                  d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"
                />
                <polyline points="14,2 14,8 20,8" />
                <line x1="16" x2="8" y1="13" y2="13" />
                <line x1="16" x2="8" y1="17" y2="17" />
                <polyline points="10,9 9,9 8,9" />
              </svg>
              <p>Aucun remboursement enregistré pour ce crédit</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Message when no credit selected -->
    <div id="noCreditMessage" class="card hidden">
      <div class="card-content" style="text-align: center; padding: 48px 16px">
        <svg
          style="width: 64px; height: 64px; margin: 0 auto 16px; color: #d1d5db"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
        >
          <rect width="20" height="14" x="2" y="5" rx="2" />
          <line x1="2" x2="22" y1="10" y2="10" />
        </svg>
        <h3
          style="
            font-size: 1.25rem;
            font-weight: 600;
            color: #6b7280;
            margin-bottom: 8px;
          "
        >
          Sélectionnez un crédit
        </h3>
        <p style="color: #6b7280">
          Choisissez un crédit dans la liste ci-dessus pour commencer un
          remboursement
        </p>
      </div>
    </div>
  </div>
</div>

<div id="toast" class="toast">
  <span id="toastMessage"></span>
</div>

<script>
  // Variables globales
  let availableCredits = [];
  let currentCredit = null;
  let payments = [];

  // Fonctions utilitaires (inchangées)
  function formatCurrency(amount) {
    return new Intl.NumberFormat("fr-FR", {
      style: "currency",
      currency: "XOF",
    }).format(amount);
  }

  function calculateProgress(paid, total) {
    if (total === 0) return 0; // Prevent division by zero
    return Math.round((paid / total) * 100);
  }

  function showToast(message, type = "success") {
    console.log("DEBUG TOAST: Message reçu:", message, "Type:", type); // LIGNE À AJOUTER
    const toast = document.getElementById("toast");

    // Validation du message
    if (!message || typeof message !== "string") {
      console.error("Message toast invalide:", message);
      message =
        type === "error" ? "Une erreur est survenue" : "Opération réussie";
    }

    // Limiter la longueur du message (cette partie est ok)
    if (message.length > 150) {
      message = message.substring(0, 147) + "...";
    }

    toast.textContent = message;
    toast.className = `toast show ${type}`;

    setTimeout(
      () => {
        toast.className = "toast";
      },
      type === "error" ? 5000 : 3000
    );
  }

  function formatDate(dateString) {
    // Handle both YYYY-MM-DD (from form) and ISO string (from API DateTimeField)
    if (!dateString) return "-";
    try {
      const date = new Date(dateString);
      return date.toLocaleDateString("fr-FR");
    } catch (e) {
      console.error("Invalid date string:", dateString, e);
      return dateString; // Fallback to original string if invalid
    }
  }

  function getCurrentDate() {
    return new Date().toISOString().split("T")[0];
  }

  // Chargement des crédits disponibles depuis l'API Django
  async function loadAvailableCredits() {
    try {
      const response = await fetch("/GMyCom/tableau-bord/credits/api/liste/"); // L'URL de votre API Django
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      const data = await response.json();
      // Convertir les montants de string à Decimal/Number si nécessaire
      availableCredits = data.map((credit) => ({
        ...credit,
        montant: parseFloat(credit.montant || "0"), // Utilise '0' si credit.montant est null/undefined
        montant_rembourse: parseFloat(credit.montant_rembourse || "0"),
        taux_interet: parseFloat(credit.taux_interet),
        montant_restant_du: parseFloat(credit.montant_restant_du),
      }));

      populateCreditSelect();
    } catch (error) {
      console.error("Erreur lors du chargement des crédits:", error);
      showToast("Impossible de charger la liste des crédits", "error");
    } finally {
      document.getElementById("loadingState").classList.add("hidden");
      document.getElementById("creditSelection").classList.remove("hidden");
      document.getElementById("noCreditMessage").classList.remove("hidden");
    }
  }

  // Remplir le sélecteur de crédits (mis à jour pour utiliser montant_restant_du)
  function populateCreditSelect() {
    const select = document.getElementById("credit-select");
    select.innerHTML =
      '<option value="">Sélectionnez un crédit à rembourser</option>'; // Vider avant de remplir

    availableCredits.forEach((credit) => {
      const option = document.createElement("option");
      option.value = credit.id;
      // Utilisez le montant_restant_du directement si fourni par l'API
      const restant = credit.montant_restant_du;
      option.textContent = `${credit.numero_credit} - ${
        credit.client_nom_complet
      } (Restant: ${formatCurrency(restant)})`;
      select.appendChild(option);
    });
  }

  // Gestion du changement de crédit sélectionné (inchangée)
  document
    .getElementById("credit-select")
    .addEventListener("change", function (e) {
      const creditId = e.target.value;

      if (!creditId) {
        document.getElementById("mainContent").classList.add("hidden");
        document.getElementById("noCreditMessage").classList.remove("hidden");
        currentCredit = null;
        payments = [];
        return;
      }

      document.getElementById("noCreditMessage").classList.add("hidden");
      loadCreditData(creditId);
    });

  // Chargement des données d'un crédit spécifique depuis l'API
  async function loadCreditData(creditId) {
    document.getElementById("paymentsLoading").style.display = "flex"; // Afficher le loading de l'historique
    document.getElementById("paymentsTable").style.display = "none";
    document.getElementById("paymentsEmpty").style.display = "none";

    try {
      currentCredit = availableCredits.find((c) => c.id === creditId);

      if (!currentCredit) {
        showToast("Crédit sélectionné introuvable.", "error");
        return;
      }

      // Charger l'historique des paiements depuis l'API
      const response = await fetch(
        `/GMyCom/tableau-bord/remboursement/api/credits/${creditId}/payments/`
      );
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      payments = await response.json();
      // Convertir les montants de string à Decimal/Number
      payments = payments.map((payment) => ({
        ...payment,
        montant: parseFloat(payment.montant),
      }));

      displayCreditInfo();
      displayPaymentHistory();

      document.getElementById("mainContent").classList.remove("hidden");
    } catch (error) {
      console.error("Erreur lors du chargement des données du crédit:", error);
      showToast("Impossible de charger les informations du crédit", "error");
      document.getElementById("mainContent").classList.add("hidden"); // Masquer si erreur
      document.getElementById("noCreditMessage").classList.remove("hidden"); // Afficher le message d'absence
    } finally {
      document.getElementById("paymentsLoading").style.display = "none"; // Masquer le loading
    }
  }

  // Affichage des informations du crédit (mis à jour pour utiliser les données réelles)
  function displayCreditInfo() {
    if (!currentCredit) return;

    // Recalculer le montant restant et la progression localement pour l'affichage
    // puisque le currentCredit est mis à jour après un nouveau paiement
    const totalPaid = payments.reduce((sum, p) => sum + p.montant, 0);
    const montantRestant = currentCredit.montant - totalPaid; // Ou currentCredit.montant_restant_du si l'API le fournit mis à jour
    const progress = calculateProgress(totalPaid, currentCredit.montant);

    // Informations du crédit
    document.getElementById("creditNumber").textContent =
      currentCredit.numero_credit;
    document.getElementById("clientName").textContent =
      currentCredit.client_nom_complet;
    document.getElementById("accountNumber").textContent =
      currentCredit.numero_compte;
    document.getElementById("creditAmount").textContent = formatCurrency(
      currentCredit.montant
    );
    document.getElementById(
      "interestRate"
    ).textContent = `${currentCredit.taux_interet}%`;
    document.getElementById(
      "duration"
    ).textContent = `${currentCredit.duree_mois} mois`;
    document.getElementById("remainingAmount").textContent =
      formatCurrency(montantRestant);

    // Progression
    document.getElementById("progressPercent").textContent = `${progress}%`;
    document.getElementById("progressFill").style.width = `${progress}%`;
    document.getElementById("paidAmount").textContent =
      formatCurrency(totalPaid);
    document.getElementById("totalAmount").textContent = formatCurrency(
      currentCredit.montant
    );

    // Configuration du formulaire
    document.getElementById("montant").max = montantRestant;
    document.getElementById(
      "maxAmountHint"
    ).textContent = `Maximum: ${formatCurrency(montantRestant)}`;
    document.getElementById("date_paiement").value = getCurrentDate();
  }

  // Affichage de l'historique des paiements (inchangée, car les données sont déjà formatées par l'API)
  function displayPaymentHistory() {
    const loadingElement = document.getElementById("paymentsLoading");
    const tableElement = document.getElementById("paymentsTable");
    const emptyElement = document.getElementById("paymentsEmpty");
    const tbody = document.getElementById("paymentsTableBody");

    loadingElement.style.display = "none";

    if (payments.length === 0) {
      emptyElement.style.display = "block";
      tableElement.style.display = "none";
      return;
    }

    emptyElement.style.display = "none";
    tableElement.style.display = "block";

    tbody.innerHTML = payments
      .map(
        (payment) => `
                <tr>
                    <td>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <svg class="icon" viewBox="0 0 24 24">
                                <rect width="18" height="18" x="3" y="4" rx="2" ry="2"/>
                                <line x1="16" x2="16" y1="2" y2="6"/>
                                <line x1="8" x2="8" y1="2" y2="6"/>
                                <line x1="3" x2="21" y1="10" y2="10"/>
                            </svg>
                            ${formatDate(payment.date_paiement)}
                        </div>
                    </td>
                    <td style="font-weight: 500; color: #059669;">
                        ${formatCurrency(payment.montant)}
                    </td>
                    <td>
                        <span class="payment-method-badge">
                            ${payment.methode_paiement}
                        </span>
                    </td>
                    <td style="font-family: monospace; font-size: 0.875rem;">
                        ${payment.reference || "-"}
                    </td>
                    <td style="color: #6b7280; font-size: 0.875rem;">
                        ${payment.notes || "-"}
                    </td>
                </tr>
            `
      )
      .join("");
  }

  // Gestion du formulaire de paiement (mise à jour pour envoyer à l'API Django)
  document
    .getElementById("paymentForm")
    .addEventListener("submit", async function (e) {
      e.preventDefault();

      if (!currentCredit) {
        showToast("Veuillez d'abord sélectionner un crédit", "error");
        return;
      }

      const formData = new FormData(this);
      const montant = parseFloat(formData.get("montant"));
      // Recalculer le montant restant à partir des paiements actuels pour validation
      const currentTotalPaid = payments.reduce((sum, p) => sum + p.montant, 0);
      const montantRestant = currentCredit.montant - currentTotalPaid;

      // Validation
      if (isNaN(montant) || montant <= 0) {
        showToast("Veuillez saisir un montant valide et positif", "error");
        return;
      }

      if (montant > montantRestant + 0.01) {
        // Ajouter une petite tolérance pour les flottants
        showToast(
          `Le montant ne peut pas dépasser le montant restant (${formatCurrency(
            montantRestant
          )})`,
          "error"
        );
        return;
      }
      if (montantRestant <= 0) {
        showToast("Ce crédit est déjà entièrement remboursé.", "error");
        return;
      }

      // Désactiver le bouton de soumission
      const submitBtn = document.getElementById("submitBtn");
      const originalText = submitBtn.textContent;
      submitBtn.textContent = "Enregistrement...";
      submitBtn.disabled = true;

      try {
        const response = await fetch(
          "/GMyCom/tableau-bord/remboursement/api/repayments/record/",
          {
            // L'URL de votre API Django
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-CSRFToken": getCookie("csrftoken"),
              "X-Requested-With": "XMLHttpRequest",
            },
            body: JSON.stringify({
              credit_id: currentCredit.id,
              montant: montant,
              date_paiement: formData.get("date_paiement"),
              methode_paiement: formData.get("methode_paiement"),
              reference: formData.get("reference"),
              notes: formData.get("notes"),
            }),
          }
        );

        const result = await response.json();

        if (!response.ok) {
          throw new Error(
            result.error || "Erreur lors de l'enregistrement du remboursement"
          );
        }

        showToast(
          result.message || "Le remboursement a été enregistré avec succès",
          "success"
        );

        // Recharger les données du crédit et de l'historique après un enregistrement réussi
        // pour s'assurer que l'UI reflète l'état réel de la base de données
        await loadCreditData(currentCredit.id);

        // Réinitialisation du formulaire (sauf la date_paiement qui revient à la date actuelle)
        this.reset();
        document.getElementById("date_paiement").value = getCurrentDate();
      } catch (error) {
        console.error("Erreur lors de l'enregistrement:", error);
        showToast(
          error.message || "Impossible d'enregistrer le remboursement",
          "error"
        );
      } finally {
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
      }
    });

  // Fonction pour récupérer le jeton CSRF (nécessaire en production)
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
      const cookies = document.cookie.split(";");
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        // Does this cookie string begin with the name we want?
        if (cookie.substring(0, name.length + 1) === name + "=") {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  // Chargement initial
  document.addEventListener("DOMContentLoaded", () => {
    loadAvailableCredits();
  });
</script>
{%endblock%}
